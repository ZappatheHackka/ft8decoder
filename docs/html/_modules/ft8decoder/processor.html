<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" />
        <link rel="canonical" href="/ft8decoder/_modules/ft8decoder/processor.html" />

    <!-- Generated with Sphinx 8.1.3 and Furo 2025.07.19 -->
        <title>ft8decoder.processor - ft8decoder 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=30c0293a" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=25af2a20" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #2b2b2b;
  --color-code-foreground: #f8f8f2;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #2b2b2b;
  --color-code-foreground: #f8f8f2;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">ft8decoder 0.1.0 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  <span class="sidebar-brand-text">ft8decoder 0.1.0 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  
</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for ft8decoder.processor</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">threading</span><span class="w"> </span><span class="kn">import</span> <span class="n">Thread</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">maidenhead</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mh</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">folium</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ft8decoder.core</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">asdict</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>

<div class="viewcode-block" id="MessageProcessor">
<a class="viewcode-back" href="../../index.html#ft8decoder.processor.MessageProcessor">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">MessageProcessor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Processes and categorizes FT8 messages into QSOs, CQs, and miscellaneous communications.</span>

<span class="sd">        This class takes parsed FT8 packets and intelligently categorizes them based on</span>
<span class="sd">        message content and structure. It tracks complete QSO (contact) sequences,</span>
<span class="sd">        identifies CQ calls, handles grid square exchanges, and provides data export</span>
<span class="sd">        and mapping functionality.</span>

<span class="sd">        The processor understands FT8 protocol semantics including:</span>
<span class="sd">        - CQ calls (general and targeted)</span>
<span class="sd">        - Two-way QSO establishment and completion</span>
<span class="sd">        - Signal reports and grid square exchanges</span>
<span class="sd">        - Various acknowledgment and sign-off messages</span>

<span class="sd">        Attributes:</span>
<span class="sd">            logger (logging.Logger): Logger for this class</span>
<span class="sd">            cqs (list): List of unmatched CQ calls</span>
<span class="sd">            qso_coords (list): Coordinates for completed QSOs with grid squares</span>
<span class="sd">            cq_coords (list): Coordinates for CQ calls with grid squares</span>
<span class="sd">            grid_square_cache (dict): Cache mapping callsigns to their grid squares</span>
<span class="sd">            data_motherload (list): Raw packet buffer from parser</span>
<span class="sd">            misc_comms (dict): Miscellaneous communications that don&#39;t fit QSO pattern</span>
<span class="sd">            qso_dict (dict): Complete QSO conversations indexed by sorted callsign pairs</span>
<span class="sd">            translation_templates (dict): Templates for translating special CQ types</span>
<span class="sd">            master_data (list): Combined view of all processed data</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; processor = MessageProcessor()</span>
<span class="sd">            &gt;&gt;&gt; processor.start(seconds=5)  # Process packets every 5 seconds</span>
<span class="sd">            &gt;&gt;&gt; # After some time...</span>
<span class="sd">            &gt;&gt;&gt; processor.to_json(&quot;ft8_data&quot;)  # Export all data</span>
<span class="sd">            &gt;&gt;&gt; processor.to_map(&quot;ft8_map&quot;)   # Create world map</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Initialize the FT8 message processor.</span>

<span class="sd">                Sets up logging, initializes data structures for tracking different</span>
<span class="sd">                message types, and defines translation templates for special CQ calls</span>
<span class="sd">                like contests, Parks/Summits on the Air, and geographic targets.</span>

<span class="sd">                Args:</span>
<span class="sd">                    log_level (int, optional): Python logging level. Defaults to logging.INFO.</span>

<span class="sd">                Example:</span>
<span class="sd">                    &gt;&gt;&gt; processor = MessageProcessor(log_level=logging.DEBUG)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">log_level</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
            <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
            <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(name)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cqs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qso_coords</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_coords</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid_square_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_motherload</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">misc_comms</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qso_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">translation_templates</span> <span class="o">=</span> <span class="p">{</span>    <span class="c1"># Cleaner for catching rare / niche message types than endless conditionals.</span>
            <span class="s2">&quot;DX&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{sender}</span><span class="s2"> is calling long-distance stations from grid </span><span class="si">{grid}</span><span class="s2">.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;POTA&quot;</span><span class="p">:</span> <span class="s2">&quot;Parks on the Air participant </span><span class="si">{sender}</span><span class="s2"> is calling from grid </span><span class="si">{grid}</span><span class="s2">.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SOTA&quot;</span><span class="p">:</span> <span class="s2">&quot;Summits on the Air participant </span><span class="si">{sender}</span><span class="s2"> is calling from grid </span><span class="si">{grid}</span><span class="s2">.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;TEST&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{sender}</span><span class="s2"> is making a contest call from grid </span><span class="si">{grid}</span><span class="s2">.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;NA&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{sender}</span><span class="s2"> is calling North America from grid </span><span class="si">{grid}</span><span class="s2">.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;EU&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{sender}</span><span class="s2"> is calling Europe from grid </span><span class="si">{grid}</span><span class="s2">.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SA&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{sender}</span><span class="s2"> is calling South America from grid </span><span class="si">{grid}</span><span class="s2">.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;AS&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{sender}</span><span class="s2"> is calling Asia from grid </span><span class="si">{grid}</span><span class="s2">.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{sender}</span><span class="s2"> is calling Africa from grid </span><span class="si">{grid}</span><span class="s2">.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;OC&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{sender}</span><span class="s2"> is calling Oceania from grid </span><span class="si">{grid}</span><span class="s2">.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;JA&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{sender}</span><span class="s2"> is calling Japan from grid </span><span class="si">{grid}</span><span class="s2">.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;HL&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{sender}</span><span class="s2"> is calling South Korea from grid </span><span class="si">{grid}</span><span class="s2">.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;VK&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{sender}</span><span class="s2"> is calling Australia from grid </span><span class="si">{grid}</span><span class="s2">.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UA&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{sender}</span><span class="s2"> is calling Russia from grid </span><span class="si">{grid}</span><span class="s2">.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;BV&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{sender}</span><span class="s2"> is calling Taiwan from grid </span><span class="si">{grid}</span><span class="s2">.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;VOTA&quot;</span><span class="p">:</span> <span class="s2">&quot;Volunteers On The Air participant </span><span class="si">{sender}</span><span class="s2"> is calling from grid </span><span class="si">{grid}</span><span class="s2">.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ZL&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{sender}</span><span class="s2"> is calling New Zealand from grid </span><span class="si">{grid}</span><span class="s2">.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CN&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{sender}</span><span class="s2"> is calling China from grid </span><span class="si">{grid}</span><span class="s2">.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;BY&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{sender}</span><span class="s2"> is calling China from grid </span><span class="si">{grid}</span><span class="s2">.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;WFD&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{sender}</span><span class="s2"> is operating in Winter Field Day from grid </span><span class="si">{grid}</span><span class="s2">.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;FD&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{sender}</span><span class="s2"> is operating in Field Day from grid </span><span class="si">{grid}</span><span class="s2">.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SKCC&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{sender}</span><span class="s2"> is calling SKCC (Straight Key Century Club) members from grid </span><span class="si">{grid}</span><span class="s2">.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;NAQP&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{sender}</span><span class="s2"> is participating in the North American QSO Party from grid </span><span class="si">{grid}</span><span class="s2">.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ARRL&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{sender}</span><span class="s2"> is participating in an ARRL event from grid </span><span class="si">{grid}</span><span class="s2">.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CQWW&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{sender}</span><span class="s2"> is participating in CQ World Wide from grid </span><span class="si">{grid}</span><span class="s2">.&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">master_data</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;Successfull Comms&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">qso_dict</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;CQs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cqs</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;Misc. Comms&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">misc_comms</span><span class="p">}]</span>


<div class="viewcode-block" id="MessageProcessor.start">
<a class="viewcode-back" href="../../index.html#ft8decoder.processor.MessageProcessor.start">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">               Start the message processing thread.</span>

<span class="sd">               Launches a background thread that periodically processes accumulated</span>
<span class="sd">               packets from the data buffer. The thread runs continuously, processing</span>
<span class="sd">               packets at the specified interval.</span>

<span class="sd">               Args:</span>
<span class="sd">                   seconds (int, optional): Interval between processing cycles in seconds.</span>
<span class="sd">                                          Defaults to 5. Shorter intervals provide more</span>
<span class="sd">                                          real-time processing but use more CPU.</span>

<span class="sd">               Example:</span>
<span class="sd">                   &gt;&gt;&gt; processor = MessageProcessor()</span>
<span class="sd">                   &gt;&gt;&gt; processor.start(seconds=3)  # Process every 3 seconds</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">organize_messages</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">seconds</span><span class="p">,))</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Message processor started with </span><span class="si">{</span><span class="n">seconds</span><span class="si">}</span><span class="s2">s intervals&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="MessageProcessor.organize_messages">
<a class="viewcode-back" href="../../index.html#ft8decoder.processor.MessageProcessor.organize_messages">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">organize_messages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seconds</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Main message processing loop that categorizes FT8 messages.</span>

<span class="sd">        This method runs continuously in a background thread, processing</span>
<span class="sd">        accumulated packets at regular intervals. It handles the complete</span>
<span class="sd">        FT8 message classification workflow:</span>

<span class="sd">        1. Copies and clears the packet buffer</span>
<span class="sd">        2. Parses each message to identify type (CQ, QSO, misc)</span>
<span class="sd">        3. Routes messages to appropriate handlers</span>
<span class="sd">        4. Tracks QSO progression and completion</span>

<span class="sd">        Args:</span>
<span class="sd">            seconds (int): Sleep interval between processing cycles.</span>

<span class="sd">        Message Classification Logic:</span>
<span class="sd">            - CQ messages: Start with &quot;CQ&quot; keyword</span>
<span class="sd">            - Two-word messages: Grid squares, sign-offs, acknowledgments</span>
<span class="sd">            - Three-word messages: Standard QSO exchanges (callsign pairs + data)</span>
<span class="sd">            - Four+ word messages: Special CQs with targets/events</span>

<span class="sd">        Example message flows:</span>
<span class="sd">            &gt;&gt;&gt; # CQ sequence</span>
<span class="sd">            &gt;&gt;&gt; &quot;CQ W1ABC FN42&quot; -&gt; handle_cq()</span>
<span class="sd">            &gt;&gt;&gt; &quot;W1ABC K2DEF&quot; -&gt; new QSO started</span>
<span class="sd">            &gt;&gt;&gt; &quot;K2DEF W1ABC -15&quot; -&gt; signal report</span>
<span class="sd">            &gt;&gt;&gt; &quot;W1ABC K2DEF FN42&quot; -&gt; grid square</span>
<span class="sd">            &gt;&gt;&gt; &quot;K2DEF W1ABC RRR&quot; -&gt; acknowledgment</span>
<span class="sd">            &gt;&gt;&gt; &quot;W1ABC K2DEF 73&quot; -&gt; QSO completed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span>
            <span class="n">packets_to_process</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_motherload</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_motherload</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">packets_to_process</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">packets_to_process</span><span class="p">)</span><span class="si">}</span><span class="s2"> packets...&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">packet</span> <span class="ow">in</span> <span class="n">packets_to_process</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="n">packet</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">message</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;CQ&quot;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">handle_cq</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">handle_short_msg</span><span class="p">(</span><span class="n">packet</span><span class="o">=</span><span class="n">packet</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">handle_longer_msg</span><span class="p">(</span><span class="n">packet</span><span class="o">=</span><span class="n">packet</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>
                            <span class="k">continue</span>
                        <span class="c1"># TODO Handle messages w/ &gt;3 words (dx etc)</span>
                        <span class="n">message_callsigns</span> <span class="o">=</span> <span class="p">[</span><span class="n">message</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">message</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                        <span class="c1"># TODO: Add more robust parsing to catch callsigns of all shapes and sizes</span>
                        <span class="n">callsigns</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">message_callsigns</span><span class="p">)</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">callsigns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">callsigns</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">qso_dict</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sort_message</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">callsigns</span><span class="p">,</span> <span class="n">new_convo</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">qso_dict</span><span class="p">[(</span><span class="n">callsigns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">callsigns</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;completed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sort_message</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">callsigns</span><span class="p">,</span> <span class="n">new_convo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing packet </span><span class="si">{</span><span class="n">packet</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">packets_to_process</span><span class="p">)</span><span class="si">}</span><span class="s2"> packets successfully&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No packets found, waiting </span><span class="si">{</span><span class="n">seconds</span><span class="si">}</span><span class="s2"> more seconds...&quot;</span><span class="p">)</span></div>


    <span class="c1"># Handles new messages &amp; retroactively places CQ call in list</span>
<div class="viewcode-block" id="MessageProcessor.sort_message">
<a class="viewcode-back" href="../../index.html#ft8decoder.processor.MessageProcessor.sort_message">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">sort_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">packet</span><span class="p">:</span> <span class="n">Packet</span><span class="p">,</span> <span class="n">callsigns</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">new_convo</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Route QSO messages to appropriate handlers based on content.</span>

<span class="sd">        This method analyzes three-word FT8 messages (typically callsign pairs</span>
<span class="sd">        plus additional data) and routes them to specialized handlers based on</span>
<span class="sd">        the message type. For new conversations, it also searches for and</span>
<span class="sd">        incorporates any matching CQ call.</span>

<span class="sd">        Args:</span>
<span class="sd">            packet (Packet): The packet containing the message to process.</span>
<span class="sd">            callsigns (list): Sorted list of two callsigns from the message.</span>
<span class="sd">            new_convo (bool): True if this is the first message in a QSO.</span>

<span class="sd">        Message Types Handled:</span>
<span class="sd">            - Acknowledgments: RRR, RR73, 73 (conversation enders)</span>
<span class="sd">            - Grid squares: 4-character locator codes (e.g., FN42, IO91)</span>
<span class="sd">            - Signal reports: Numeric SNR values with optional R/RR prefix</span>
<span class="sd">            - Unknown: Added to misc_comms for manual review</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # New QSO starting</span>
<span class="sd">            &gt;&gt;&gt; sort_message(packet, [&#39;K2DEF&#39;, &#39;W1ABC&#39;], new_convo=True)</span>
<span class="sd">            &gt;&gt;&gt; # Continues existing QSO</span>
<span class="sd">            &gt;&gt;&gt; sort_message(packet, [&#39;K2DEF&#39;, &#39;W1ABC&#39;], new_convo=False)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">new_convo</span><span class="p">:</span>
            <span class="c1"># TODO Reorder checking order, place CQ updater in first func [DONE]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_cq</span><span class="p">(</span><span class="n">callsigns</span><span class="o">=</span><span class="n">callsigns</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">packet</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ack_reply</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handle_ack_reply</span><span class="p">(</span><span class="n">callsigns</span><span class="p">,</span> <span class="n">packet</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_grid_square</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handle_grid_square</span><span class="p">(</span><span class="n">callsigns</span><span class="p">,</span> <span class="n">packet</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_signal_report</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handle_signal_report</span><span class="p">(</span><span class="n">callsigns</span><span class="p">,</span> <span class="n">packet</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not parse packet: </span><span class="si">{</span><span class="n">packet</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">, adding to misc_comms&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">misc_comms</span><span class="p">[(</span><span class="n">message</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">message</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">=</span> <span class="n">packet</span></div>


<div class="viewcode-block" id="MessageProcessor.handle_short_msg">
<a class="viewcode-back" href="../../index.html#ft8decoder.processor.MessageProcessor.handle_short_msg">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">handle_short_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">packet</span><span class="p">:</span> <span class="n">Packet</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process two-word FT8 messages.</span>

<span class="sd">        Handles various two-word message types including grid square announcements,</span>
<span class="sd">        sign-offs, acknowledgments, and QRP (low power) indicators. These messages</span>
<span class="sd">        are typically not part of structured QSOs but provide important information</span>
<span class="sd">        or conclude conversations.</span>

<span class="sd">        Args:</span>
<span class="sd">            packet (Packet): The packet containing the two-word message.</span>
<span class="sd">            message (list): List of two words from the message.</span>

<span class="sd">        Message Types:</span>
<span class="sd">            - Grid announcements: &quot;CALLSIGN GRID&quot; (e.g., &quot;W1ABC FN42&quot;)</span>
<span class="sd">            - Sign-offs: &quot;CALLSIGN 73&quot; (goodbye message)</span>
<span class="sd">            - Roger + sign-off: &quot;CALLSIGN RR73&quot; (acknowledgment + goodbye)</span>
<span class="sd">            - QRP indicators: &quot;CALLSIGN/QRP CALLSIGN&quot; (low power operations)</span>
<span class="sd">            - Simple pings: &quot;CALLSIGN1 CALLSIGN2&quot; (basic contact attempt)</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; handle_short_msg(packet, [&quot;W1ABC&quot;, &quot;FN42&quot;])  # Grid announcement</span>
<span class="sd">            &gt;&gt;&gt; handle_short_msg(packet, [&quot;W1ABC&quot;, &quot;73&quot;])    # Sign-off</span>
<span class="sd">            &gt;&gt;&gt; handle_short_msg(packet, [&quot;W1ABC/QRP&quot;, &quot;K2DEF&quot;])  # QRP ping</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">second_part</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_grid_square</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
            <span class="n">convo_turn</span> <span class="o">=</span> <span class="n">MessageTurn</span><span class="p">(</span><span class="n">turn</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">message</span><span class="p">),</span> <span class="n">translated_message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">message</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;announces their position at </span><span class="si">{</span><span class="n">second_part</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">packet</span><span class="o">=</span><span class="n">packet</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;Grid Square announcement.&quot;</span><span class="p">)</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">misc_comms</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">misc_comms</span><span class="p">[(</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">convo_turn</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updated misc_comms list with message!&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">misc_comms</span><span class="p">[(</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">=</span> <span class="p">[</span><span class="n">convo_turn</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updated misc_comms list with message!&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">second_part</span> <span class="o">==</span> <span class="s2">&quot;73&quot;</span><span class="p">:</span>
            <span class="n">convo_turn</span> <span class="o">=</span> <span class="n">MessageTurn</span><span class="p">(</span><span class="n">turn</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">message</span><span class="p">),</span>
                                     <span class="n">translated_message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">message</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> says goodbye.&quot;</span><span class="p">,</span>
                                     <span class="n">packet</span><span class="o">=</span><span class="n">packet</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;73 sign off.&quot;</span><span class="p">)</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="c1"># TODO write search func that can check main list for potential matches--where is the message 73ing to?</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">misc_comms</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">misc_comms</span><span class="p">[(</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">convo_turn</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updated misc_comms list with message!&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">misc_comms</span><span class="p">[(</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">=</span> <span class="p">[</span><span class="n">convo_turn</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updated misc_comms list with message!&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">second_part</span> <span class="o">==</span> <span class="s2">&quot;RR73&quot;</span><span class="p">:</span>
            <span class="n">convo_turn</span> <span class="o">=</span> <span class="n">MessageTurn</span><span class="p">(</span><span class="n">turn</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">message</span><span class="p">),</span>
                                     <span class="n">translated_message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">message</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> says Roger Roger and signs off.&quot;</span><span class="p">,</span>
                                     <span class="n">packet</span><span class="o">=</span><span class="n">packet</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;RR73&quot;</span><span class="p">)</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">misc_comms</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">misc_comms</span><span class="p">[(</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">convo_turn</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updated misc_comms list with message!&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">misc_comms</span><span class="p">[(</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">=</span> <span class="p">[</span><span class="n">convo_turn</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updated misc_comms list with message!&quot;</span><span class="p">)</span>
        <span class="c1"># Just two callsigns</span>
        <span class="k">elif</span> <span class="s2">&quot;/QRP&quot;</span> <span class="ow">in</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;/QRP&quot;</span> <span class="ow">in</span> <span class="n">message</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">qso_dict</span><span class="p">:</span>
                    <span class="n">convo_turn</span> <span class="o">=</span> <span class="n">MessageTurn</span><span class="p">(</span><span class="n">turn</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qso_dict</span><span class="p">[(</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">])]),</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">message</span><span class="p">),</span>
                                             <span class="n">translated_message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">message</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> pings low power </span><span class="si">{</span><span class="n">message</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
                                             <span class="n">packet</span><span class="o">=</span><span class="n">packet</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;Two Callsigns&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">qso_dict</span><span class="p">[(</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">convo_turn</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updated qso_dict with message!&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">convo_turn</span> <span class="o">=</span> <span class="n">MessageTurn</span><span class="p">(</span><span class="n">turn</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">message</span><span class="p">),</span>
                                             <span class="n">translated_message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">message</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> pings low power </span><span class="si">{</span><span class="n">message</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
                                             <span class="n">packet</span><span class="o">=</span><span class="n">packet</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;Two Callsigns&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">qso_dict</span><span class="p">[(</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;completed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span> <span class="n">convo_turn</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updated qso_dict with message!&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">qso_dict</span><span class="p">:</span>
                    <span class="n">convo_turn</span> <span class="o">=</span> <span class="n">MessageTurn</span><span class="p">(</span><span class="n">turn</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qso_dict</span><span class="p">[(</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">])]),</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">message</span><span class="p">),</span>
                                             <span class="n">translated_message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">message</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> pings </span><span class="si">{</span><span class="n">message</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> at low power.&quot;</span><span class="p">,</span>
                                             <span class="n">packet</span><span class="o">=</span><span class="n">packet</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;Two Callsigns&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">qso_dict</span><span class="p">[(</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">convo_turn</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updated qso_dict with message!&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">convo_turn</span> <span class="o">=</span> <span class="n">MessageTurn</span><span class="p">(</span><span class="n">turn</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">message</span><span class="p">),</span>
                                             <span class="n">translated_message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">message</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> pings </span><span class="si">{</span><span class="n">message</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> at low power.&quot;</span><span class="p">,</span>
                                             <span class="n">packet</span><span class="o">=</span><span class="n">packet</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;Two Callsigns&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">qso_dict</span><span class="p">[(</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;completed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span> <span class="n">convo_turn</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updated qso_dict with message!&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">qso_dict</span><span class="p">:</span>
                <span class="n">convo_turn</span> <span class="o">=</span> <span class="n">MessageTurn</span><span class="p">(</span><span class="n">turn</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qso_dict</span><span class="p">[(</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">])]),</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">message</span><span class="p">),</span>
                                         <span class="n">translated_message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">message</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> pings </span><span class="si">{</span><span class="n">message</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">packet</span><span class="o">=</span><span class="n">packet</span><span class="p">,</span>
                                         <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;Two Callsigns.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">qso_dict</span><span class="p">[(</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">convo_turn</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updated qso_dict with message!&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">convo_turn</span> <span class="o">=</span> <span class="n">MessageTurn</span><span class="p">(</span><span class="n">turn</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">message</span><span class="p">),</span> <span class="n">translated_message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">message</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> pings &quot;</span>
                                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">message</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">packet</span><span class="o">=</span><span class="n">packet</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;Two Callsigns.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">qso_dict</span><span class="p">[(</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;completed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span> <span class="n">convo_turn</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updated qso_dict with message!&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="MessageProcessor.handle_longer_msg">
<a class="viewcode-back" href="../../index.html#ft8decoder.processor.MessageProcessor.handle_longer_msg">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">handle_longer_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">packet</span><span class="p">:</span> <span class="n">Packet</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">               Process messages with more than three words.</span>

<span class="sd">               Handles specialized CQ calls that include specific targets or event</span>
<span class="sd">               indicators. These four-word messages typically follow the format:</span>
<span class="sd">               &quot;CQ EVENT CALLSIGN GRID&quot; where EVENT specifies the type of activity</span>
<span class="sd">               or geographic target.</span>

<span class="sd">               Args:</span>
<span class="sd">                   packet (Packet): The packet containing the multi-word message.</span>
<span class="sd">                   message (list): List of words from the message (4+ words expected).</span>

<span class="sd">               Expected Format:</span>
<span class="sd">                   message[0]: &quot;CQ&quot; (already verified by caller)</span>
<span class="sd">                   message[1]: Event/target code (e.g., &quot;DX&quot;, &quot;POTA&quot;, &quot;TEST&quot;, &quot;NA&quot;)</span>
<span class="sd">                   message[2]: Calling station&#39;s callsign</span>
<span class="sd">                   message[3]: Calling station&#39;s grid square</span>

<span class="sd">               Example:</span>
<span class="sd">                   &gt;&gt;&gt; handle_longer_msg(packet, [&quot;CQ&quot;, &quot;POTA&quot;, &quot;W1ABC&quot;, &quot;FN42&quot;])</span>
<span class="sd">                   &gt;&gt;&gt; # Creates: &quot;Parks on the Air participant W1ABC is calling from grid FN42.&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">callsign</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">translation_templates</span><span class="p">:</span>  <span class="c1"># Only called for four part CQs</span>
            <span class="n">translated_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">translation_templates</span><span class="p">[</span><span class="n">code</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="n">callsign</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">)</span>
            <span class="n">convo_turn</span> <span class="o">=</span> <span class="n">CQ</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">message</span><span class="p">),</span> <span class="n">translated_message</span><span class="o">=</span><span class="n">translated_message</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="n">callsign</span><span class="p">,</span>
                            <span class="n">packet</span><span class="o">=</span><span class="n">packet</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">callsign</span><span class="p">,</span> <span class="n">grid</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_square_cache</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">grid_square_cache</span><span class="p">[</span><span class="n">callsign</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cqs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">convo_turn</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updated qso_dict with longer message!&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="MessageProcessor.is_signal_report">
<a class="viewcode-back" href="../../index.html#ft8decoder.processor.MessageProcessor.is_signal_report">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_signal_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">               Determine if a message contains an FT8 signal report.</span>

<span class="sd">               FT8 signal reports are numeric values (typically -24 to +50 dB) that</span>
<span class="sd">               indicate signal strength and decoding quality. They may be prefixed</span>
<span class="sd">               with &#39;R&#39; (received/roger) or &#39;RR&#39; (roger roger) to indicate acknowledgment.</span>

<span class="sd">               Args:</span>
<span class="sd">                   message (list): List of words from the FT8 message.</span>

<span class="sd">               Returns:</span>
<span class="sd">                   bool: True if the last word appears to be a signal report.</span>

<span class="sd">               Signal Report Formats:</span>
<span class="sd">                   - Simple: &quot;+05&quot;, &quot;-15&quot;, &quot;00&quot; (raw SNR values)</span>
<span class="sd">                   - Roger: &quot;R+05&quot;, &quot;R-15&quot; (acknowledging receipt)</span>
<span class="sd">                   - Roger Roger: &quot;RR+05&quot;, &quot;RR-15&quot; (confirming exchange)</span>

<span class="sd">               Example:</span>
<span class="sd">                   &gt;&gt;&gt; is_signal_report([&quot;W1ABC&quot;, &quot;K2DEF&quot;, &quot;-15&quot;])  # True</span>
<span class="sd">                   &gt;&gt;&gt; is_signal_report([&quot;W1ABC&quot;, &quot;K2DEF&quot;, &quot;R+05&quot;])  # True</span>
<span class="sd">                   &gt;&gt;&gt; is_signal_report([&quot;W1ABC&quot;, &quot;K2DEF&quot;, &quot;73&quot;])    # False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># &gt; 2 to return False for 73s</span>
            <span class="k">if</span> <span class="n">signal</span> <span class="o">!=</span> <span class="s2">&quot;RR73&quot;</span> <span class="ow">and</span> <span class="n">signal</span> <span class="o">!=</span> <span class="s2">&quot;RRR&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;RR&#39;</span> <span class="ow">in</span> <span class="n">signal</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">signal</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span> <span class="ow">or</span> <span class="n">signal</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;00&#39;</span><span class="p">:</span>
                            <span class="k">return</span> <span class="kc">True</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="s1">&#39;R&#39;</span> <span class="ow">in</span> <span class="n">signal</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">signal</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span> <span class="ow">or</span> <span class="n">signal</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;00&#39;</span><span class="p">:</span>
                            <span class="k">return</span> <span class="kc">True</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">signal</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="ow">or</span> <span class="n">signal</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;00&#39;</span><span class="p">:</span>
                            <span class="k">return</span> <span class="kc">True</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">False</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="MessageProcessor.handle_signal_report">
<a class="viewcode-back" href="../../index.html#ft8decoder.processor.MessageProcessor.handle_signal_report">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">handle_signal_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callsigns</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">packet</span><span class="p">:</span> <span class="n">Packet</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Process FT8 signal report exchanges.</span>

<span class="sd">                Signal reports are a critical part of FT8 QSOs, indicating how well</span>
<span class="sd">                each station is receiving the other. This method creates a MessageTurn</span>
<span class="sd">                object with appropriate human-readable translation and adds it to the</span>
<span class="sd">                ongoing QSO conversation.</span>

<span class="sd">                Args:</span>
<span class="sd">                    callsigns (list): Sorted pair of callsigns involved in the QSO.</span>
<span class="sd">                    packet (Packet): The packet containing the signal report.</span>
<span class="sd">                    message (list): Message words, with signal report as the last element.</span>

<span class="sd">                Signal Report Translation:</span>
<span class="sd">                    - Reports with &#39;R&#39; prefix indicate acknowledgment of previous report</span>
<span class="sd">                    - Numeric value represents signal-to-noise ratio in dB</span>
<span class="sd">                    - Positive values indicate strong signals, negative indicate weak</span>

<span class="sd">                Example:</span>
<span class="sd">                    &gt;&gt;&gt; # Message: [&quot;W1ABC&quot;, &quot;K2DEF&quot;, &quot;R-08&quot;]</span>
<span class="sd">                    &gt;&gt;&gt; handle_signal_report([&quot;K2DEF&quot;, &quot;W1ABC&quot;], packet, message)</span>
<span class="sd">                    &gt;&gt;&gt; # Creates: &quot;K2DEF says Roger and reports a signal report of -08 to W1ABC.&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">first_callsign</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">second_callsign</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">nums</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">translated_message</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">second_callsign</span><span class="si">}</span><span class="s2"> says Roger and reports a signal report of </span><span class="si">{</span><span class="n">nums</span><span class="si">}</span><span class="s2"> &quot;</span>
                                  <span class="sa">f</span><span class="s2">&quot;to </span><span class="si">{</span><span class="n">first_callsign</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">translated_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">second_callsign</span><span class="si">}</span><span class="s2"> sends a signal report of </span><span class="si">{</span><span class="n">message</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">first_callsign</span><span class="si">}</span><span class="s2">.&quot;</span>

        <span class="c1"># Putting this as the second signal report--assuming the CQ caller sends report first</span>
        <span class="n">m_type</span> <span class="o">=</span> <span class="s2">&quot;Signal Report&quot;</span>
        <span class="n">turn_obj</span> <span class="o">=</span> <span class="n">MessageTurn</span><span class="p">(</span><span class="n">turn</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qso_dict</span><span class="p">[(</span><span class="n">callsigns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">callsigns</span><span class="p">[</span><span class="mi">1</span><span class="p">])]),</span>
                               <span class="n">message</span><span class="o">=</span><span class="n">packet</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">translated_message</span><span class="o">=</span><span class="n">translated_message</span><span class="p">,</span> <span class="n">packet</span><span class="o">=</span><span class="n">packet</span><span class="p">,</span>
                               <span class="nb">type</span><span class="o">=</span><span class="n">m_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qso_dict</span><span class="p">[(</span><span class="n">callsigns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">callsigns</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">turn_obj</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updated qso_dict with signal report.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="MessageProcessor.is_ack_reply">
<a class="viewcode-back" href="../../index.html#ft8decoder.processor.MessageProcessor.is_ack_reply">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_ack_reply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">               Determine if a message is an acknowledgment or sign-off.</span>

<span class="sd">               FT8 conversations typically end with acknowledgment codes that confirm</span>
<span class="sd">               receipt of information and/or indicate the QSO is complete.</span>

<span class="sd">               Args:</span>
<span class="sd">                   message (list): List of words from the FT8 message.</span>

<span class="sd">               Returns:</span>
<span class="sd">                   bool: True if the message ends with a recognized acknowledgment code.</span>

<span class="sd">               Acknowledgment Types:</span>
<span class="sd">                   - &quot;RRR&quot;: Roger Roger Roger (confirmation received)</span>
<span class="sd">                   - &quot;RR73&quot;: Roger Roger + 73 (confirmation + goodbye)</span>
<span class="sd">                   - &quot;73&quot;: Best wishes/goodbye (QSO completion)</span>

<span class="sd">               Example:</span>
<span class="sd">                   &gt;&gt;&gt; is_ack_reply([&quot;W1ABC&quot;, &quot;K2DEF&quot;, &quot;RRR&quot;])   # True</span>
<span class="sd">                   &gt;&gt;&gt; is_ack_reply([&quot;W1ABC&quot;, &quot;K2DEF&quot;, &quot;RR73&quot;])  # True</span>
<span class="sd">                   &gt;&gt;&gt; is_ack_reply([&quot;W1ABC&quot;, &quot;K2DEF&quot;, &quot;FN42&quot;])  # False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="s2">&quot;RRR&quot;</span> <span class="ow">or</span> <span class="n">code</span> <span class="o">==</span> <span class="s2">&quot;RR73&quot;</span> <span class="ow">or</span> <span class="n">code</span> <span class="o">==</span> <span class="s2">&quot;73&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="MessageProcessor.handle_ack_reply">
<a class="viewcode-back" href="../../index.html#ft8decoder.processor.MessageProcessor.handle_ack_reply">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">handle_ack_reply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callsigns</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">packet</span><span class="p">:</span> <span class="n">Packet</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process acknowledgment and sign-off messages in QSOs.</span>

<span class="sd">        Handles the final stages of FT8 QSOs where stations confirm receipt</span>
<span class="sd">        of information and formally conclude the contact. Different acknowledgment</span>
<span class="sd">        types have specific meanings and some mark the QSO as completed.</span>

<span class="sd">        Args:</span>
<span class="sd">            callsigns (list): Sorted pair of callsigns involved in the QSO.</span>
<span class="sd">            packet (Packet): The packet containing the acknowledgment.</span>
<span class="sd">            message (list): Message words, with acknowledgment code as last element.</span>

<span class="sd">        Acknowledgment Processing:</span>
<span class="sd">            - &quot;RRR&quot;: Simple confirmation, QSO implied complete</span>
<span class="sd">            - &quot;RR73&quot;: Confirmation + goodbye, marks QSO as completed</span>
<span class="sd">            - &quot;73&quot;: Goodbye message, marks QSO as completed</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # Message: [&quot;W1ABC&quot;, &quot;K2DEF&quot;, &quot;RR73&quot;]</span>
<span class="sd">            &gt;&gt;&gt; handle_ack_reply([&quot;K2DEF&quot;, &quot;W1ABC&quot;], packet, message)</span>
<span class="sd">            &gt;&gt;&gt; # Marks QSO as completed and adds final turn</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ack</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ack</span> <span class="o">==</span> <span class="s2">&quot;RRR&quot;</span><span class="p">:</span>
            <span class="n">translated_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">message</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> sends a Roger Roger Roger to </span><span class="si">{</span><span class="n">message</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="n">convo_turn</span> <span class="o">=</span> <span class="n">MessageTurn</span><span class="p">(</span><span class="n">turn</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qso_dict</span><span class="p">[(</span><span class="n">callsigns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">callsigns</span><span class="p">[</span><span class="mi">1</span><span class="p">])])),</span> <span class="n">message</span><span class="o">=</span><span class="n">packet</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
                                     <span class="n">translated_message</span><span class="o">=</span><span class="n">translated_message</span><span class="p">,</span> <span class="n">packet</span><span class="o">=</span><span class="n">packet</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;RRR&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qso_dict</span><span class="p">[(</span><span class="n">callsigns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">callsigns</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">convo_turn</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qso_dict</span><span class="p">[(</span><span class="n">callsigns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">callsigns</span><span class="p">[</span><span class="mi">1</span><span class="p">])][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;completed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updated qso_dict with RRR reply.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ack</span> <span class="o">==</span> <span class="s2">&quot;RR73&quot;</span><span class="p">:</span>
            <span class="n">translated_message</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">message</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> sends a Roger Roger to </span><span class="si">{</span><span class="n">message</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> and says goodbye, &quot;</span>
                                  <span class="sa">f</span><span class="s2">&quot;concluding the connection.&quot;</span><span class="p">)</span>
            <span class="n">convo_turn</span> <span class="o">=</span> <span class="n">MessageTurn</span><span class="p">(</span><span class="n">turn</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qso_dict</span><span class="p">[(</span><span class="n">callsigns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">callsigns</span><span class="p">[</span><span class="mi">1</span><span class="p">])])),</span> <span class="n">message</span><span class="o">=</span><span class="n">packet</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
                                     <span class="n">translated_message</span><span class="o">=</span><span class="n">translated_message</span><span class="p">,</span> <span class="n">packet</span><span class="o">=</span><span class="n">packet</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;RR &amp; Goodbye&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qso_dict</span><span class="p">[(</span><span class="n">callsigns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">callsigns</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">convo_turn</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qso_dict</span><span class="p">[(</span><span class="n">callsigns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">callsigns</span><span class="p">[</span><span class="mi">1</span><span class="p">])][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;completed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updated qso_dict with RR73 reply.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ack</span> <span class="o">==</span> <span class="s2">&quot;73&quot;</span><span class="p">:</span>
            <span class="n">translated_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">message</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> sends their well wishes to </span><span class="si">{</span><span class="n">message</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, concluding the connection.&quot;</span>
            <span class="n">convo_turn</span> <span class="o">=</span> <span class="n">MessageTurn</span><span class="p">(</span><span class="n">turn</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qso_dict</span><span class="p">[(</span><span class="n">callsigns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">callsigns</span><span class="p">[</span><span class="mi">1</span><span class="p">])])),</span> <span class="n">message</span><span class="o">=</span><span class="n">packet</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
                                     <span class="n">translated_message</span><span class="o">=</span><span class="n">translated_message</span><span class="p">,</span> <span class="n">packet</span><span class="o">=</span><span class="n">packet</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;Goodbye&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qso_dict</span><span class="p">[(</span><span class="n">callsigns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">callsigns</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">convo_turn</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qso_dict</span><span class="p">[(</span><span class="n">callsigns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">callsigns</span><span class="p">[</span><span class="mi">1</span><span class="p">])][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;completed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updated qso_dict with 73 reply.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="MessageProcessor.is_grid_square">
<a class="viewcode-back" href="../../index.html#ft8decoder.processor.MessageProcessor.is_grid_square">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_grid_square</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Determine if a message contains a Maidenhead grid square locator.</span>

<span class="sd">                Maidenhead grid squares are a coordinate system used by amateur radio</span>
<span class="sd">                operators to specify geographic location. They follow the format of</span>
<span class="sd">                two uppercase letters followed by two digits (e.g., FN42, IO91).</span>

<span class="sd">                Args:</span>
<span class="sd">                    message (list): List of words from the FT8 message.</span>

<span class="sd">                Returns:</span>
<span class="sd">                    bool: True if the last word is a valid 4-character grid square.</span>

<span class="sd">                Grid Square Format:</span>
<span class="sd">                    - Character 1: Uppercase letter (A-R, longitude field)</span>
<span class="sd">                    - Character 2: Uppercase letter (A-R, latitude field)</span>
<span class="sd">                    - Character 3: Digit (0-9, longitude square)</span>
<span class="sd">                    - Character 4: Digit (0-9, latitude square)</span>

<span class="sd">                Example:</span>
<span class="sd">                    &gt;&gt;&gt; is_grid_square([&quot;W1ABC&quot;, &quot;K2DEF&quot;, &quot;FN42&quot;])  # True (valid grid)</span>
<span class="sd">                    &gt;&gt;&gt; is_grid_square([&quot;W1ABC&quot;, &quot;K2DEF&quot;, &quot;fn42&quot;])  # False (lowercase)</span>
<span class="sd">                    &gt;&gt;&gt; is_grid_square([&quot;W1ABC&quot;, &quot;K2DEF&quot;, &quot;FN4&quot;])   # False (too short)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">square</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">callsign</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">square</span><span class="p">)</span>  <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">square</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isalpha</span><span class="p">()</span> <span class="ow">and</span> <span class="n">square</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isupper</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">square</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isalpha</span><span class="p">()</span> <span class="ow">and</span> <span class="n">square</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isupper</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">square</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">isnumeric</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">square</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">isnumeric</span><span class="p">():</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">callsign</span><span class="p">,</span> <span class="n">square</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_square_cache</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">grid_square_cache</span><span class="p">[</span><span class="n">callsign</span><span class="p">]</span> <span class="o">=</span> <span class="n">square</span>
                            <span class="k">return</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">return</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="MessageProcessor.handle_grid_square">
<a class="viewcode-back" href="../../index.html#ft8decoder.processor.MessageProcessor.handle_grid_square">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">handle_grid_square</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callsigns</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">packet</span><span class="p">:</span> <span class="n">Packet</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">               Process grid square location exchanges in QSOs.</span>

<span class="sd">               Grid square exchanges are a standard part of FT8 QSOs, allowing</span>
<span class="sd">               operators to share their geographic locations. The grid square is</span>
<span class="sd">               cached for later use in mapping and coordinate resolution.</span>

<span class="sd">               Args:</span>
<span class="sd">                   callsigns (list): Sorted pair of callsigns involved in the QSO.</span>
<span class="sd">                   packet (Packet): The packet containing the grid square.</span>
<span class="sd">                   message (list): Message words, with grid square as the last element.</span>

<span class="sd">               Example:</span>
<span class="sd">                   &gt;&gt;&gt; # Message: [&quot;W1ABC&quot;, &quot;K2DEF&quot;, &quot;FN42&quot;]</span>
<span class="sd">                   &gt;&gt;&gt; handle_grid_square([&quot;K2DEF&quot;, &quot;W1ABC&quot;], packet, message)</span>
<span class="sd">                   &gt;&gt;&gt; # Creates: &quot;K2DEF sends a grid square location of FN42 to W1ABC.&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">grid_square</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">translated_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">message</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> sends a grid square location of </span><span class="si">{</span><span class="n">grid_square</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">message</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="n">convo_turn</span> <span class="o">=</span> <span class="n">MessageTurn</span><span class="p">(</span><span class="n">turn</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qso_dict</span><span class="p">[(</span><span class="n">callsigns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">callsigns</span><span class="p">[</span><span class="mi">1</span><span class="p">])])),</span>
                                 <span class="n">message</span><span class="o">=</span><span class="n">packet</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">translated_message</span><span class="o">=</span><span class="n">translated_message</span><span class="p">,</span> <span class="n">packet</span><span class="o">=</span><span class="n">packet</span><span class="p">,</span>
                                 <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;Grid Square Report&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qso_dict</span><span class="p">[(</span><span class="n">callsigns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">callsigns</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">convo_turn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updated qso_dict with grid square report.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="MessageProcessor.handle_cq">
<a class="viewcode-back" href="../../index.html#ft8decoder.processor.MessageProcessor.handle_cq">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">handle_cq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">packet</span><span class="p">:</span> <span class="n">Packet</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Process CQ (calling any station) messages.</span>

<span class="sd">                CQ calls are the foundation of amateur radio contacts, indicating that</span>
<span class="sd">                a station is available for communication. This method handles various</span>
<span class="sd">                CQ formats from simple general calls to complex targeted calls with</span>
<span class="sd">                event indicators.</span>

<span class="sd">                Args:</span>
<span class="sd">                    packet (Packet): The packet containing the CQ message.</span>

<span class="sd">                CQ Message Formats:</span>
<span class="sd">                    - 2 words: &quot;CQ CALLSIGN&quot; (general call)</span>
<span class="sd">                    - 3 words: &quot;CQ CALLSIGN GRID&quot; (call with location)</span>
<span class="sd">                    - 4 words: &quot;CQ EVENT CALLSIGN GRID&quot; (targeted/special event call)</span>

<span class="sd">                Example:</span>
<span class="sd">                    &gt;&gt;&gt; handle_cq(packet)  # packet.message = &quot;CQ W1ABC FN42&quot;</span>
<span class="sd">                    &gt;&gt;&gt; # Creates: &quot;Station W1ABC is calling for any response from grid FN42.&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">split_message</span> <span class="o">=</span> <span class="n">packet</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">split_message</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handle_longer_msg</span><span class="p">(</span><span class="n">packet</span><span class="o">=</span><span class="n">packet</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">split_message</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">split_message</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">caller</span> <span class="o">=</span> <span class="n">packet</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="n">packet</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">grid</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_square_cache</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">grid_square_cache</span><span class="p">[</span><span class="n">caller</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid</span>
            <span class="n">translated</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Station </span><span class="si">{</span><span class="n">caller</span><span class="si">}</span><span class="s2"> is calling for any response from grid </span><span class="si">{</span><span class="n">grid</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="n">cq</span> <span class="o">=</span> <span class="n">CQ</span><span class="p">(</span><span class="n">packet</span><span class="o">=</span><span class="n">packet</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">packet</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="n">caller</span><span class="p">,</span> <span class="n">translated_message</span><span class="o">=</span><span class="n">translated</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cqs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cq</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updated qso_dict with CQ.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">split_message</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">caller</span> <span class="o">=</span> <span class="n">packet</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">translated</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Station </span><span class="si">{</span><span class="n">caller</span><span class="si">}</span><span class="s2"> is calling for any response.&quot;</span>
            <span class="n">cq</span> <span class="o">=</span> <span class="n">CQ</span><span class="p">(</span><span class="n">packet</span><span class="o">=</span><span class="n">packet</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">packet</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="n">caller</span><span class="p">,</span> <span class="n">translated_message</span><span class="o">=</span><span class="n">translated</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cqs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cq</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updated qso_dict with CQ.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cq</span> <span class="o">=</span> <span class="n">CQ</span><span class="p">(</span><span class="n">packet</span><span class="o">=</span><span class="n">packet</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">packet</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="n">packet</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">translated_message</span><span class="o">=</span><span class="s2">&quot;Unconfigured&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cqs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cq</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updated qso_dict with CQ.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="MessageProcessor.add_cq">
<a class="viewcode-back" href="../../index.html#ft8decoder.processor.MessageProcessor.add_cq">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_cq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callsigns</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">               Link CQ calls to newly started QSOs.</span>

<span class="sd">               When a new QSO begins, this method searches for any matching CQ call</span>
<span class="sd">               from one of the participants and incorporates it as the first turn</span>
<span class="sd">               of the conversation. This provides complete context for how the</span>
<span class="sd">               contact was initiated.</span>

<span class="sd">               Args:</span>
<span class="sd">                   callsigns (list): Sorted pair of callsigns starting a new QSO.</span>

<span class="sd">               Process:</span>
<span class="sd">                   1. Search through unmatched CQ calls</span>
<span class="sd">                   2. Find CQ from either callsign in the new QSO</span>
<span class="sd">                   3. Convert CQ to MessageTurn and insert as turn 1</span>
<span class="sd">                   4. Remove CQ from unmatched list</span>

<span class="sd">               Example:</span>
<span class="sd">                   &gt;&gt;&gt; # Previous CQ: &quot;CQ W1ABC FN42&quot;</span>
<span class="sd">                   &gt;&gt;&gt; # New QSO starts: &quot;W1ABC K2DEF&quot;</span>
<span class="sd">                   &gt;&gt;&gt; add_cq([&quot;K2DEF&quot;, &quot;W1ABC&quot;])</span>
<span class="sd">                   &gt;&gt;&gt; # CQ becomes turn 1 of the W1ABC/K2DEF conversation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">callsign</span> <span class="ow">in</span> <span class="n">callsigns</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cq</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cqs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cq</span><span class="o">.</span><span class="n">caller</span> <span class="o">==</span> <span class="n">callsign</span><span class="p">:</span>
                    <span class="n">this_cq</span> <span class="o">=</span> <span class="n">cq</span>
                    <span class="n">cq_turn</span> <span class="o">=</span> <span class="n">MessageTurn</span><span class="p">(</span><span class="n">turn</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">this_cq</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">translated_message</span><span class="o">=</span><span class="n">this_cq</span><span class="o">.</span><span class="n">translated_message</span><span class="p">,</span>
                                  <span class="n">packet</span><span class="o">=</span><span class="n">this_cq</span><span class="o">.</span><span class="n">packet</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;CQ Call.&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">qso_dict</span><span class="p">[(</span><span class="n">callsigns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">callsigns</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cq_turn</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cqs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">cq</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updated qso_dict with initial CQ call.&quot;</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span></div>


    <span class="c1"># Given grid square, returns Lat/Lon</span>
<div class="viewcode-block" id="MessageProcessor.resolve_grid_square">
<a class="viewcode-back" href="../../index.html#ft8decoder.processor.MessageProcessor.resolve_grid_square">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">resolve_grid_square</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid_square</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">               Convert Maidenhead grid square to latitude/longitude coordinates.</span>

<span class="sd">               Uses the maidenhead library to convert 4-character grid squares into</span>
<span class="sd">               decimal degree coordinates for mapping and distance calculations.</span>
<span class="sd">               Returns a dictionary with coordinate information and a Google Maps link.</span>

<span class="sd">               Args:</span>
<span class="sd">                   grid_square (str): 4-character Maidenhead grid square (e.g., &quot;FN42&quot;).</span>

<span class="sd">               Returns:</span>
<span class="sd">                   dict or None: Dictionary containing grid square, coordinates, and map URL.</span>
<span class="sd">                                Returns None if conversion fails.</span>

<span class="sd">               Return Format:</span>
<span class="sd">                   {</span>
<span class="sd">                       &quot;Grid Square&quot;: &quot;FN42&quot;,</span>
<span class="sd">                       &quot;Latitude&quot;: &quot;42.5&quot;,</span>
<span class="sd">                       &quot;Longitude&quot;: &quot;-71.5&quot;,</span>
<span class="sd">                       &quot;Map URL&quot;: &quot;https://www.google.com/maps?q=42.5,-71.5&quot;</span>
<span class="sd">                   }</span>

<span class="sd">               Example:</span>
<span class="sd">                   &gt;&gt;&gt; coords = resolve_grid_square(&quot;FN42&quot;)</span>
<span class="sd">                   &gt;&gt;&gt; print(f&quot;Location: {coords[&#39;Latitude&#39;]}, {coords[&#39;Longitude&#39;]}&quot;)</span>
<span class="sd">                   &gt;&gt;&gt; # Location: 42.5, -71.5</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">mh</span><span class="o">.</span><span class="n">to_location</span><span class="p">(</span><span class="n">grid_square</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;Grid Square&quot;</span><span class="p">:</span> <span class="n">grid_square</span><span class="p">,</span>
                <span class="s2">&quot;Latitude&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="s2">&quot;Longitude&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="s2">&quot;Map URL&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;https://www.google.com/maps?q=</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to resolve grid square </span><span class="si">{</span><span class="n">grid_square</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<span class="c1"># ---------------------DATA EXPORTING--------------------------</span>
<div class="viewcode-block" id="MessageProcessor.comms_to_json">
<a class="viewcode-back" href="../../index.html#ft8decoder.processor.MessageProcessor.comms_to_json">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">comms_to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Export QSO conversation data to JSON file.</span>

<span class="sd">        Serializes all completed and in-progress QSO conversations to a JSON</span>
<span class="sd">        file for analysis, archival, or import into other applications. Each</span>
<span class="sd">        QSO is indexed by the sorted callsign pair and contains all message</span>
<span class="sd">        turns with metadata.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (str): Output filename, .json extension added if missing.</span>

<span class="sd">        Raises:</span>
<span class="sd">            IOError: If file cannot be written due to permissions or disk space.</span>
<span class="sd">            OSError: If filename/path is invalid.</span>

<span class="sd">        JSON Structure:</span>
<span class="sd">            {</span>
<span class="sd">                &quot;COMMS&quot;: [{</span>
<span class="sd">                    &quot;(&#39;CALL1&#39;, &#39;CALL2&#39;)&quot;: [</span>
<span class="sd">                        {&quot;completed&quot;: false},</span>
<span class="sd">                        {MessageTurn data...},</span>
<span class="sd">                        {MessageTurn data...}</span>
<span class="sd">                    ]</span>
<span class="sd">                }]</span>
<span class="sd">            }</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; processor.comms_to_json(&quot;my_qsos&quot;)</span>
<span class="sd">            &gt;&gt;&gt; # Creates my_qsos.json with all QSO data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">):</span>
            <span class="n">out_filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.json&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
                <span class="n">json_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;COMMS&quot;</span><span class="p">:</span> <span class="p">[{}]}</span>

                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">qso_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">key_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                    <span class="n">json_dict</span><span class="p">[</span><span class="s2">&quot;COMMS&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">key_str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">MessageTurn</span><span class="p">):</span>
                            <span class="n">json_dict</span><span class="p">[</span><span class="s2">&quot;COMMS&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">key_str</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">asdict</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">json_dict</span><span class="p">[</span><span class="s2">&quot;COMMS&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">key_str</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">json_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">Packet</span><span class="p">):</span>
                            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">json_dict</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">json_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
                            <span class="n">json_dict</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;packet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">asdict</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

                <span class="n">json_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">json_dict</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;QSOs exported to </span><span class="si">{</span><span class="n">out_filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to write QSOs to </span><span class="si">{</span><span class="n">out_filename</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span></div>


<div class="viewcode-block" id="MessageProcessor.cqs_to_json">
<a class="viewcode-back" href="../../index.html#ft8decoder.processor.MessageProcessor.cqs_to_json">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cqs_to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Export unanswered CQ calls to JSON file.</span>

<span class="sd">                Saves all CQ calls that have not yet been matched to QSO conversations.</span>
<span class="sd">                Useful for analyzing calling patterns, popular frequencies, and</span>
<span class="sd">                propagation conditions.</span>

<span class="sd">                Args:</span>
<span class="sd">                    filename (str): Output filename, .json extension added if missing.</span>

<span class="sd">                Raises:</span>
<span class="sd">                    IOError: If file cannot be written.</span>
<span class="sd">                    OSError: If filename/path is invalid.</span>

<span class="sd">                JSON Structure:</span>
<span class="sd">                    {</span>
<span class="sd">                        &quot;CQS&quot;: [</span>
<span class="sd">                            {CQ object data...},</span>
<span class="sd">                            {CQ object data...}</span>
<span class="sd">                        ]</span>
<span class="sd">                    }</span>

<span class="sd">                Example:</span>
<span class="sd">                    &gt;&gt;&gt; processor.cqs_to_json(&quot;unanswered_cqs&quot;)</span>
<span class="sd">                    &gt;&gt;&gt; # Creates unanswered_cqs.json with CQ data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">):</span>
            <span class="n">out_filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.json&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
                <span class="n">json_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;CQS&quot;</span><span class="p">:</span> <span class="p">[]}</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cq</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cqs</span><span class="p">):</span>
                    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">json_dict</span><span class="p">[</span><span class="s2">&quot;CQS&quot;</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">i</span><span class="p">:</span>
                        <span class="n">json_dict</span><span class="p">[</span><span class="s2">&quot;CQS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>

                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cq</span><span class="p">,</span> <span class="n">CQ</span><span class="p">):</span>
                        <span class="n">json_dict</span><span class="p">[</span><span class="s2">&quot;CQS&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">asdict</span><span class="p">(</span><span class="n">cq</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">json_dict</span><span class="p">[</span><span class="s2">&quot;CQS&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cq</span>

                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">json_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">Packet</span><span class="p">):</span>
                            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">json_dict</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">json_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
                            <span class="n">json_dict</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;packet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">asdict</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

                <span class="n">json_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">json_dict</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CQs exported to </span><span class="si">{</span><span class="n">out_filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to write CQs to </span><span class="si">{</span><span class="n">out_filename</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span></div>


<div class="viewcode-block" id="MessageProcessor.misc_to_json">
<a class="viewcode-back" href="../../index.html#ft8decoder.processor.MessageProcessor.misc_to_json">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">misc_to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Export miscellaneous communications to JSON file.</span>

<span class="sd">        Saves communications that don&#39;t fit the standard QSO pattern, including</span>
<span class="sd">        grid announcements, standalone sign-offs, and unrecognized message formats.</span>
<span class="sd">        Useful for debugging message parsing and analyzing non-standard activity.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (str): Output filename, .json extension added if missing.</span>

<span class="sd">        Raises:</span>
<span class="sd">            IOError: If file cannot be written.</span>
<span class="sd">            OSError: If filename/path is invalid.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; processor.misc_to_json(&quot;misc_messages&quot;)</span>
<span class="sd">            &gt;&gt;&gt; # Creates misc_messages.json</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">):</span>
            <span class="n">out_filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.json&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
                <span class="n">json_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;MISC&quot;</span><span class="p">:</span> <span class="p">[]}</span>

                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">misc_comms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">key_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                    <span class="n">json_dict</span><span class="p">[</span><span class="s2">&quot;MISC. COMMS&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">key_str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">MessageTurn</span><span class="p">):</span>
                            <span class="n">json_dict</span><span class="p">[</span><span class="s2">&quot;MISC. COMMS&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">key_str</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">asdict</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">json_dict</span><span class="p">[</span><span class="s2">&quot;MISC. COMMS&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">key_str</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">json_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">Packet</span><span class="p">):</span>
                            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">json_dict</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">json_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
                            <span class="n">json_dict</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;packet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">asdict</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                <span class="n">json_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">json_dict</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;misc messages exported to </span><span class="si">{</span><span class="n">out_filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to write misc messages to </span><span class="si">{</span><span class="n">out_filename</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span></div>


<div class="viewcode-block" id="MessageProcessor.to_json">
<a class="viewcode-back" href="../../index.html#ft8decoder.processor.MessageProcessor.to_json">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Export all captured FT8 data to a comprehensive JSON file.</span>

<span class="sd">        Creates a complete export containing QSO conversations, unanswered CQ calls,</span>
<span class="sd">        and miscellaneous communications in a single file. This is the most</span>
<span class="sd">        comprehensive export option for complete session analysis.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (str): Output filename, .json extension added if missing.</span>

<span class="sd">        Raises:</span>
<span class="sd">            IOError: If file cannot be written due to permissions or disk space.</span>
<span class="sd">            OSError: If filename/path is invalid.</span>

<span class="sd">        JSON Structure:</span>
<span class="sd">            {</span>
<span class="sd">                &quot;COMMS&quot;: [{QSO conversations...}],</span>
<span class="sd">                &quot;CQS&quot;: [{CQ calls...}],</span>
<span class="sd">                &quot;MISC. COMMS&quot;: [{miscellaneous messages...}]</span>
<span class="sd">            }</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; processor.to_json(&quot;complete_session&quot;)</span>
<span class="sd">            &gt;&gt;&gt; # Creates complete_session.json with all data types</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">):</span>
            <span class="n">out_filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.json&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
                <span class="n">json_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;COMMS&quot;</span><span class="p">:</span> <span class="p">[{}],</span> <span class="s2">&quot;CQS&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;MISC. COMMS&quot;</span><span class="p">:</span> <span class="p">[{}]}</span>

                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">qso_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">key_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                    <span class="n">json_dict</span><span class="p">[</span><span class="s2">&quot;COMMS&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">key_str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">MessageTurn</span><span class="p">):</span>
                            <span class="n">json_dict</span><span class="p">[</span><span class="s2">&quot;COMMS&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">key_str</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">asdict</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">json_dict</span><span class="p">[</span><span class="s2">&quot;COMMS&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">key_str</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cq</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cqs</span><span class="p">):</span>
                    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">json_dict</span><span class="p">[</span><span class="s2">&quot;CQS&quot;</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">i</span><span class="p">:</span>
                        <span class="n">json_dict</span><span class="p">[</span><span class="s2">&quot;CQS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>

                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cq</span><span class="p">,</span> <span class="n">CQ</span><span class="p">):</span>
                        <span class="n">json_dict</span><span class="p">[</span><span class="s2">&quot;CQS&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">asdict</span><span class="p">(</span><span class="n">cq</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">json_dict</span><span class="p">[</span><span class="s2">&quot;CQS&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cq</span>

                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">misc_comms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">key_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                    <span class="n">json_dict</span><span class="p">[</span><span class="s2">&quot;MISC. COMMS&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">key_str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">MessageTurn</span><span class="p">):</span>
                            <span class="n">json_dict</span><span class="p">[</span><span class="s2">&quot;MISC. COMMS&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">key_str</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">asdict</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">json_dict</span><span class="p">[</span><span class="s2">&quot;MISC. COMMS&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">key_str</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">json_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">Packet</span><span class="p">):</span>
                            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">json_dict</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">json_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
                            <span class="n">json_dict</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;packet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">asdict</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">json_dict</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">json_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All messages exported to </span><span class="si">{</span><span class="n">out_filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to write all messages to </span><span class="si">{</span><span class="n">out_filename</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span></div>


<span class="c1"># -------------MAPPING-------------</span>

<div class="viewcode-block" id="MessageProcessor.gather_coords">
<a class="viewcode-back" href="../../index.html#ft8decoder.processor.MessageProcessor.gather_coords">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">gather_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">               Collect and resolve geographic coordinates for QSOs and CQ calls.</span>

<span class="sd">               Processes the grid square cache to convert Maidenhead locators into</span>
<span class="sd">               latitude/longitude coordinates for mapping purposes. Creates coordinate</span>
<span class="sd">               tuples for both QSOs (with connection lines, as long as both participants have sent their grid squares)</span>
<span class="sd">               and CQ calls (as individual points).</span>

<span class="sd">               Coordinate Resolution Process:</span>
<span class="sd">                   1. Check QSO participants for cached grid squares</span>
<span class="sd">                   2. Resolve grid squares to lat/lon coordinates</span>
<span class="sd">                   3. Create QSO coordinate tuples with both endpoints</span>
<span class="sd">                   4. Process CQ calls similarly for standalone points</span>

<span class="sd">               Populates:</span>
<span class="sd">                   self.qso_coords: List of QSO coordinate tuples</span>
<span class="sd">                   self.cq_coords: List of CQ coordinate tuples</span>

<span class="sd">               QSO Coordinate Format:</span>
<span class="sd">                   ((callsign1, lat1, lon1), (callsign2, lat2, lon2), (timestamp,))</span>

<span class="sd">               CQ Coordinate Format:</span>
<span class="sd">                   (message, timestamp, latitude, longitude)</span>

<span class="sd">               Example:</span>
<span class="sd">                   &gt;&gt;&gt; processor.gather_coords()</span>
<span class="sd">                   &gt;&gt;&gt; print(f&quot;Found {len(processor.qso_coords)} QSOs with coordinates&quot;)</span>
<span class="sd">                   &gt;&gt;&gt; print(f&quot;Found {len(processor.cq_coords)} CQs with coordinates&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">qso_dict</span><span class="p">:</span> <span class="c1"># Gathering QSO coords</span>
            <span class="k">if</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_square_cache</span> <span class="ow">and</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_square_cache</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qso_dict</span><span class="p">[(</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">time_captured</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qso_dict</span><span class="p">[(</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">])][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">packet</span><span class="o">.</span><span class="n">time_captured</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">time_captured</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qso_dict</span><span class="p">[(</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">])][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">packet</span><span class="o">.</span><span class="n">time_captured</span>
                <span class="n">first_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_grid_square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_square_cache</span><span class="p">[</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                <span class="n">second_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_grid_square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_square_cache</span><span class="p">[</span><span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>

                <span class="k">if</span> <span class="n">first_coords</span> <span class="ow">and</span> <span class="n">second_coords</span><span class="p">:</span>
                    <span class="n">coord_tuple</span> <span class="o">=</span> <span class="p">((</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">first_coords</span><span class="p">[</span><span class="s2">&quot;Latitude&quot;</span><span class="p">],</span> <span class="n">first_coords</span><span class="p">[</span><span class="s2">&quot;Longitude&quot;</span><span class="p">]),</span>
                                   <span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">second_coords</span><span class="p">[</span><span class="s2">&quot;Latitude&quot;</span><span class="p">],</span> <span class="n">second_coords</span><span class="p">[</span><span class="s2">&quot;Longitude&quot;</span><span class="p">]),</span>
                                   <span class="p">(</span><span class="n">time_captured</span><span class="p">,))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">qso_coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coord_tuple</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added coordinates for QSO between </span><span class="si">{</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to resolve coordinates for QSO between </span><span class="si">{</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing grid squares for QSO between </span><span class="si">{</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">cq</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cqs</span><span class="p">:</span> <span class="c1"># Gathering CQ coords</span>
            <span class="n">split_message</span> <span class="o">=</span> <span class="n">cq</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">time_captured</span> <span class="o">=</span> <span class="n">cq</span><span class="o">.</span><span class="n">packet</span><span class="o">.</span><span class="n">time_captured</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">split_message</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">callsign</span> <span class="o">=</span> <span class="n">split_message</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">callsign</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_square_cache</span><span class="p">:</span>
                    <span class="n">cq_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_grid_square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_square_cache</span><span class="p">[</span><span class="n">callsign</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">cq_coords</span><span class="p">:</span>
                        <span class="n">cq_tuple</span> <span class="o">=</span> <span class="p">(</span><span class="n">cq</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">time_captured</span><span class="p">,</span> <span class="n">cq_coords</span><span class="p">[</span><span class="s2">&quot;Latitude&quot;</span><span class="p">],</span> <span class="n">cq_coords</span><span class="p">[</span><span class="s2">&quot;Longitude&quot;</span><span class="p">])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cq_coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cq_tuple</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added coordinates for CQ from </span><span class="si">{</span><span class="n">callsign</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to resolve grid square for CQ from </span><span class="si">{</span><span class="n">callsign</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">callsign</span> <span class="o">=</span> <span class="n">split_message</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">callsign</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_square_cache</span><span class="p">:</span>
                    <span class="n">cq_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_grid_square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_square_cache</span><span class="p">[</span><span class="n">callsign</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">cq_coords</span><span class="p">:</span>
                        <span class="n">cq_tuple</span> <span class="o">=</span> <span class="p">(</span><span class="n">cq</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">time_captured</span><span class="p">,</span> <span class="n">cq_coords</span><span class="p">[</span><span class="s2">&quot;Latitude&quot;</span><span class="p">],</span> <span class="n">cq_coords</span><span class="p">[</span><span class="s2">&quot;Longitude&quot;</span><span class="p">])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cq_coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cq_tuple</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added coordinates for CQ from </span><span class="si">{</span><span class="n">callsign</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to resolve grid square for CQ from </span><span class="si">{</span><span class="n">callsign</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="MessageProcessor.to_map">
<a class="viewcode-back" href="../../index.html#ft8decoder.processor.MessageProcessor.to_map">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">all_cqs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Generate an interactive world map of FT8 activity.</span>

<span class="sd">                Creates a Folium-based HTML map showing QSO connections as lines between</span>
<span class="sd">                stations and CQ calls as individual markers. The map is automatically</span>
<span class="sd">                centered based on QSO activity and includes interactive layers for</span>
<span class="sd">                different data types.</span>

<span class="sd">                Args:</span>
<span class="sd">                    filename (str): Output filename for the HTML map (without .html extension).</span>
<span class="sd">                    all_cqs (bool, optional): If True, show all CQ calls. If False, only</span>
<span class="sd">                                             show CQs from stations that have not participated in a QSO.</span>
<span class="sd">                                             Defaults to True.</span>

<span class="sd">                Raises:</span>
<span class="sd">                    Exception: If map generation fails due to coordinate resolution errors</span>
<span class="sd">                              or file writing issues.</span>

<span class="sd">                Map Features:</span>
<span class="sd">                    - QSO participants: Green radio icons with callsign popups</span>
<span class="sd">                    - QSO connections: Blue lines connecting stations with QSO details</span>
<span class="sd">                    - CQ calls: Red radio icons for unanswered calls</span>
<span class="sd">                    - Layer control: Toggle between QSOs and CQs</span>
<span class="sd">                    - Auto-centering: Map centers on mean QSO coordinates</span>

<span class="sd">                Map Centering Logic:</span>
<span class="sd">                    - If 3+ QSOs with coordinates: Centers on mean lat/lon of all participants</span>
<span class="sd">                    - If &lt;3 QSOs: Uses default world view (0,0) coordinates</span>

<span class="sd">                Example:</span>
<span class="sd">                    &gt;&gt;&gt; processor.to_map(&quot;activity_map&quot;)</span>
<span class="sd">                    &gt;&gt;&gt; # Creates activity_map.html with all QSOs and CQs</span>
<span class="sd">                    &gt;&gt;&gt; processor.to_map(&quot;qso_only&quot;, all_cqs=False)</span>
<span class="sd">                    &gt;&gt;&gt; # Creates qso_only.html showing only successful contacts</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gather_coords</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qso_coords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">cumulative_lat</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">cumulative_lon</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">total_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qso_coords</span><span class="p">)</span>
                <span class="k">for</span> <span class="nb">tuple</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">qso_coords</span><span class="p">:</span>
                    <span class="n">cumulative_lat</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="nb">tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">cumulative_lon</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="nb">tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>

                <span class="n">mean_lat</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">cumulative_lat</span><span class="o">/</span><span class="n">total_len</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">mean_lon</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">cumulative_lon</span><span class="o">/</span><span class="n">total_len</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

                <span class="n">m</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="p">(</span><span class="n">mean_lat</span><span class="p">,</span> <span class="n">mean_lon</span><span class="p">),</span> <span class="n">zoom_start</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created map centered at </span><span class="si">{</span><span class="n">mean_lat</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">mean_lon</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">zoom_start</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created map with default center (insufficient QSO data for centering)&quot;</span><span class="p">)</span>

            <span class="n">cqs</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">FeatureGroup</span><span class="p">(</span><span class="s2">&quot;CQs&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="n">qsos</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">FeatureGroup</span><span class="p">(</span><span class="s2">&quot;QSOs&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">coords</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">qso_coords</span><span class="p">:</span>
                <span class="n">folium</span><span class="o">.</span><span class="n">Marker</span><span class="p">(</span>
                    <span class="n">location</span><span class="o">=</span><span class="p">[</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]],</span>
                    <span class="n">tooltip</span><span class="o">=</span><span class="s2">&quot;QSO Participant&quot;</span><span class="p">,</span>
                    <span class="n">popup</span><span class="o">=</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">icon</span><span class="o">=</span><span class="n">folium</span><span class="o">.</span><span class="n">Icon</span><span class="p">(</span><span class="n">icon</span><span class="o">=</span><span class="s1">&#39;radio&#39;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;fa&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">qsos</span><span class="p">)</span>
                <span class="n">point1</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span>

                <span class="n">folium</span><span class="o">.</span><span class="n">Marker</span><span class="p">(</span>
                    <span class="n">location</span><span class="o">=</span><span class="p">[</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]],</span>
                    <span class="n">tooltip</span><span class="o">=</span><span class="s2">&quot;QSO Participant&quot;</span><span class="p">,</span>
                    <span class="n">popup</span><span class="o">=</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">icon</span><span class="o">=</span><span class="n">folium</span><span class="o">.</span><span class="n">Icon</span><span class="p">(</span><span class="n">icon</span><span class="o">=</span><span class="s1">&#39;radio&#39;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;fa&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">qsos</span><span class="p">)</span>
                <span class="n">point2</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span>

                <span class="n">line</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">PolyLine</span><span class="p">(</span><span class="n">locations</span><span class="o">=</span><span class="p">[</span><span class="n">point1</span><span class="p">,</span> <span class="n">point2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">.55</span><span class="p">,</span>
                                       <span class="n">tooltip</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;QSO between </span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                       <span class="n">popup</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Contact began at </span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="n">line</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

                <span class="n">qso_callsigns</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">coords</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">qso_coords</span><span class="p">:</span>
                    <span class="n">qso_callsigns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="n">qso_callsigns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>

                <span class="k">for</span> <span class="n">cq</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_coords</span><span class="p">:</span>
                    <span class="n">callsign</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cq</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">all_cqs</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">callsign</span> <span class="ow">in</span> <span class="n">qso_callsigns</span><span class="p">:</span>
                            <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">time_captured</span> <span class="o">=</span> <span class="n">cq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">folium</span><span class="o">.</span><span class="n">Marker</span><span class="p">(</span>
                            <span class="n">location</span><span class="o">=</span><span class="p">[</span><span class="n">cq</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">cq</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span>
                            <span class="n">tooltip</span><span class="o">=</span><span class="s2">&quot;Unanswered CQ call&quot;</span><span class="p">,</span>
                            <span class="n">popup</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">callsign</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">time_captured</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="n">icon</span><span class="o">=</span><span class="n">folium</span><span class="o">.</span><span class="n">Icon</span><span class="p">(</span><span class="n">icon</span><span class="o">=</span><span class="s1">&#39;radio&#39;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;fa&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">cqs</span><span class="p">)</span>

            <span class="n">folium</span><span class="o">.</span><span class="n">LayerControl</span><span class="p">()</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="n">m</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.html&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Map saved as </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.html with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qso_coords</span><span class="p">)</span><span class="si">}</span><span class="s2"> QSOs&quot;</span>
                             <span class="sa">f</span><span class="s2">&quot; and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_coords</span><span class="p">)</span><span class="si">}</span><span class="s2"> CQs&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create map </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.html: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span></div>
</div>

</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, Christopher Cottone
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=01f34227"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=46bd48cc"></script>
    </body>
</html>