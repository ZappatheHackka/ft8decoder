<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ft8decoder.parser &#8212; ft8decoder 0.1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=686e5160" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <script src="../../_static/documentation_options.js?v=01f34227"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for ft8decoder.parser</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">queue</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">struct</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">threading</span><span class="w"> </span><span class="kn">import</span> <span class="n">Thread</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ft8decoder.processor</span><span class="w"> </span><span class="kn">import</span> <span class="n">MessageProcessor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ft8decoder.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">Packet</span>

<div class="viewcode-block" id="WsjtxParser">
<a class="viewcode-back" href="../../index.html#ft8decoder.parser.WsjtxParser">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">WsjtxParser</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A UDP packet parser for WSJT-X FT8 messages.</span>

<span class="sd">        This class listens for UDP packets from WSJT-X software, parses the binary</span>
<span class="sd">        packet data to extract FT8 message information, and queues the parsed packets</span>
<span class="sd">        for processing by a MessageProcessor.</span>

<span class="sd">        The parser handles WSJT-X&#39;s binary protocol format and converts frequency</span>
<span class="sd">        offsets to absolute frequencies while determining the amateur radio band</span>
<span class="sd">        based on the calculated frequency.</span>

<span class="sd">        Attributes:</span>
<span class="sd">            logger (logging.Logger): Logger instance for this class</span>
<span class="sd">            packet_queue (queue.Queue): Thread-safe queue for storing parsed packets</span>
<span class="sd">            dial_frequency (float): Base dial frequency in MHz from WSJT-X</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; parser = WsjtxParser(dial_frequency=14.074)</span>
<span class="sd">            &gt;&gt;&gt; processor = MessageProcessor()</span>
<span class="sd">            &gt;&gt;&gt; parser.start_listening(&#39;127.0.0.1&#39;, 2237, processor)</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dial_frequency</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">               Initialize the WSJT-X packet parser.</span>

<span class="sd">               Sets up logging, initializes the packet queue, and stores the dial frequency</span>
<span class="sd">               used to calculate absolute frequencies from WSJT-X frequency offsets.</span>

<span class="sd">               Args:</span>
<span class="sd">                   dial_frequency (float): The dial frequency in MHz that WSJT-X is tuned to.</span>
<span class="sd">                                         Common FT8 frequencies include 14.074 MHz (20m),</span>
<span class="sd">                                         7.074 MHz (40m), etc.</span>
<span class="sd">                   log_level (int, optional): Python logging level. Defaults to logging.INFO.</span>
<span class="sd">                                            Use logging.DEBUG for verbose output.</span>

<span class="sd">               Example:</span>
<span class="sd">                   &gt;&gt;&gt; # Initialize for 20m FT8</span>
<span class="sd">                   &gt;&gt;&gt; parser = WsjtxParser(14.074, log_level=logging.DEBUG)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">log_level</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
            <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
            <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(name)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">packet_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dial_frequency</span> <span class="o">=</span> <span class="n">dial_frequency</span>

<div class="viewcode-block" id="WsjtxParser.frequency_handle">
<a class="viewcode-back" href="../../index.html#ft8decoder.parser.WsjtxParser.frequency_handle">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">frequency_handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fq_offset</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Convert WSJT-X frequency offset to absolute frequency.</span>

<span class="sd">                WSJT-X sends frequency offsets in Hz relative to the dial frequency.</span>
<span class="sd">                This method converts the offset to MHz and adds it to the dial frequency</span>
<span class="sd">                to get the absolute transmission frequency.</span>

<span class="sd">                Args:</span>
<span class="sd">                    fq_offset (float): Frequency offset in Hz from WSJT-X packet data.</span>
<span class="sd">                                     Typically ranges from 0 to 3000 Hz for FT8.</span>

<span class="sd">                Returns:</span>
<span class="sd">                    float: Absolute frequency in MHz. Returns dial_frequency if offset</span>
<span class="sd">                          is invalid.</span>

<span class="sd">                Example:</span>
<span class="sd">                    &gt;&gt;&gt; parser = WsjtxParser(14.074)</span>
<span class="sd">                    &gt;&gt;&gt; freq = parser.frequency_handle(1500.0)  # 1500 Hz offset</span>
<span class="sd">                    &gt;&gt;&gt; print(freq)  # 14.0755 MHz</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">offset_mhz</span> <span class="o">=</span> <span class="n">fq_offset</span> <span class="o">/</span> <span class="mi">1_000_000</span>
            <span class="n">frequency</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dial_frequency</span> <span class="o">+</span> <span class="n">offset_mhz</span>
            <span class="k">return</span> <span class="n">frequency</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid frequency offset </span><span class="si">{</span><span class="n">fq_offset</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dial_frequency</span></div>


<div class="viewcode-block" id="WsjtxParser.determine_band">
<a class="viewcode-back" href="../../index.html#ft8decoder.parser.WsjtxParser.determine_band">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">determine_band</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frequency</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Determine amateur radio band from frequency.</span>

<span class="sd">                Maps the calculated frequency to the appropriate amateur radio band</span>
<span class="sd">                designation based on common FT8 frequencies. Uses a tolerance of</span>
<span class="sd">                ±15 kHz to account for frequency variations.</span>

<span class="sd">                Args:</span>
<span class="sd">                    frequency (float): Frequency in MHz to classify.</span>

<span class="sd">                Returns:</span>
<span class="sd">                    str: Band designation (e.g., &quot;20m&quot;, &quot;40m&quot;, &quot;80m&quot;) or &quot;Unknown&quot;</span>
<span class="sd">                        if frequency doesn&#39;t match any known FT8 band.</span>

<span class="sd">                Example:</span>
<span class="sd">                    &gt;&gt;&gt; parser = WsjtxParser(14.074)</span>
<span class="sd">                    &gt;&gt;&gt; band = parser.determine_band(14.076)</span>
<span class="sd">                    &gt;&gt;&gt; print(band)  # &quot;20m&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">band_center_freqs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;160m&quot;</span><span class="p">:</span> <span class="mf">1.840</span><span class="p">,</span>
            <span class="s2">&quot;80m&quot;</span><span class="p">:</span> <span class="mf">3.573</span><span class="p">,</span>
            <span class="s2">&quot;40m&quot;</span><span class="p">:</span> <span class="mf">7.074</span><span class="p">,</span>
            <span class="s2">&quot;30m&quot;</span><span class="p">:</span> <span class="mf">10.136</span><span class="p">,</span>
            <span class="s2">&quot;20m&quot;</span><span class="p">:</span> <span class="mf">14.074</span><span class="p">,</span>
            <span class="s2">&quot;17m&quot;</span><span class="p">:</span> <span class="mf">18.100</span><span class="p">,</span>
            <span class="s2">&quot;15m&quot;</span><span class="p">:</span> <span class="mf">21.074</span><span class="p">,</span>
            <span class="s2">&quot;12m&quot;</span><span class="p">:</span> <span class="mf">24.915</span><span class="p">,</span>
            <span class="s2">&quot;10m&quot;</span><span class="p">:</span> <span class="mf">28.074</span><span class="p">,</span>
            <span class="s2">&quot;6m&quot;</span><span class="p">:</span> <span class="mf">50.313</span><span class="p">,</span>
            <span class="s2">&quot;2m&quot;</span><span class="p">:</span> <span class="mf">144.174</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">band</span><span class="p">,</span> <span class="n">freq</span> <span class="ow">in</span> <span class="n">band_center_freqs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">freq</span> <span class="o">-</span> <span class="n">frequency</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.015</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">band</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown band for frequency </span><span class="si">{</span><span class="n">frequency</span><span class="si">}</span><span class="s2"> MHz&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;Unknown&quot;</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error determining band for frequency </span><span class="si">{</span><span class="n">frequency</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;Unknown&quot;</span></div>


<div class="viewcode-block" id="WsjtxParser.start_listening">
<a class="viewcode-back" href="../../index.html#ft8decoder.parser.WsjtxParser.start_listening">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">start_listening</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">processor</span><span class="p">:</span> <span class="n">MessageProcessor</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Start the UDP listening process with user confirmation.</span>

<span class="sd">                Prompts the user to confirm before starting packet capture, then</span>
<span class="sd">                launches the UDP listener in a separate thread. This is the main</span>
<span class="sd">                entry point for beginning FT8 packet capture.</span>

<span class="sd">                Args:</span>
<span class="sd">                    host (str): IP address to bind to, typically &#39;127.0.0.1&#39; for localhost.</span>
<span class="sd">                    port (int): UDP port number, typically 2237 for WSJT-X.</span>
<span class="sd">                    processor (MessageProcessor): Processor instance to handle parsed packets.</span>

<span class="sd">                Example:</span>
<span class="sd">                    &gt;&gt;&gt; parser = WsjtxParser(14.074)</span>
<span class="sd">                    &gt;&gt;&gt; processor = MessageProcessor()</span>
<span class="sd">                    &gt;&gt;&gt; parser.start_listening(&#39;127.0.0.1&#39;, 2237, processor)</span>
<span class="sd">                    Ready to listen on 127.0.0.1:2237...</span>
<span class="sd">                    Begin packet parsing? (Y/n)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ready to listen on </span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Begin packet parsing? (Y/n)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ans</span> <span class="o">==</span> <span class="s2">&quot;n&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Quitting...&quot;</span><span class="p">)</span>
            <span class="n">exit</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ans</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span>
            <span class="n">listen_thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">listen</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">processor</span><span class="p">))</span>
            <span class="n">listen_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Listening on </span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="WsjtxParser.listen">
<a class="viewcode-back" href="../../index.html#ft8decoder.parser.WsjtxParser.listen">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">listen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">processor</span><span class="p">:</span> <span class="n">MessageProcessor</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">               Main UDP listening loop.</span>

<span class="sd">               Creates a UDP socket, binds to the specified host/port, and continuously</span>
<span class="sd">               listens for WSJT-X packets. Packets are parsed and valid ones are added</span>
<span class="sd">               to the processing queue. Also starts a background thread to move packets</span>
<span class="sd">               from the queue to the processor.</span>

<span class="sd">               Args:</span>
<span class="sd">                   host (str): IP address to bind the UDP socket to.</span>
<span class="sd">                   port (int): UDP port number to bind to.</span>
<span class="sd">                   processor (MessageProcessor): Processor to handle parsed packets.</span>

<span class="sd">               Note:</span>
<span class="sd">                   This method runs in an infinite loop until a network error occurs.</span>
<span class="sd">                   Uses a 1-second timeout on socket operations to prevent blocking.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">udp_socket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">udp_socket</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parsing packets...&quot;</span><span class="p">)</span>
            <span class="n">grabbing_thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">start_grabbing</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">processor</span><span class="p">,))</span>
            <span class="n">grabbing_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">udp_socket</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">udp_socket</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">12</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">parse_packets</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Waiting for message...&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ConnectionResetError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Connection reset. Continuing...&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Network error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">break</span>

        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">msg</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Socket error: </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">. Could not listen on </span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Socket error: </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">. Could not listen on </span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="WsjtxParser.parse_packets">
<a class="viewcode-back" href="../../index.html#ft8decoder.parser.WsjtxParser.parse_packets">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">parse_packets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">               Parse binary WSJT-X packet data into structured Packet objects.</span>

<span class="sd">               Decodes the binary UDP packet format used by WSJT-X to extract message</span>
<span class="sd">               information including SNR, frequency offset, timestamp delta, and the</span>
<span class="sd">               decoded message text. Currently handles message packets (type 2) and</span>
<span class="sd">               ignores status packets (type 1).</span>

<span class="sd">               Args:</span>
<span class="sd">                   data (bytes): Raw UDP packet data from WSJT-X, minimum 12 bytes.</span>

<span class="sd">               The WSJT-X packet format includes:</span>
<span class="sd">                   - Header: Magic number, schema version, packet type</span>
<span class="sd">                   - Message data: SNR, time delta, frequency offset, message text</span>

<span class="sd">               Example packet structure for type 2 (message):</span>
<span class="sd">                   [0:4]   Magic number</span>
<span class="sd">                   [4:8]   Schema version</span>
<span class="sd">                   [8:12]  Message type (2 for decoded messages)</span>
<span class="sd">                   [27:31] SNR in dB</span>
<span class="sd">                   [31:39] Time delta in seconds</span>
<span class="sd">                   [39:43] Frequency offset in Hz</span>
<span class="sd">                   [52:-2] UTF-8 encoded message text</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">message_type</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;I&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">12</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">match</span> <span class="n">message_type</span><span class="p">:</span>
                <span class="k">case</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span> <span class="c1"># Message packets</span>
                        <span class="n">schema</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&gt;I&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">8</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">program</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&gt;6s&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">16</span><span class="p">:</span><span class="mi">22</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                        <span class="n">snr</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;i&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">27</span><span class="p">:</span><span class="mi">31</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">time_delta</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;d&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">31</span><span class="p">:</span><span class="mi">39</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">fq_offset</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&gt;i&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">39</span><span class="p">:</span><span class="mi">43</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">52</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                        <span class="n">decoded_msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                        <span class="n">frequency</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency_handle</span><span class="p">(</span><span class="n">fq_offset</span><span class="p">)</span>
                        <span class="n">time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                        <span class="n">parsed_packet</span> <span class="o">=</span> <span class="n">Packet</span><span class="p">(</span><span class="n">packet_type</span><span class="o">=</span><span class="n">message_type</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span> <span class="n">program</span><span class="o">=</span><span class="n">program</span><span class="p">,</span> <span class="n">snr</span><span class="o">=</span><span class="n">snr</span><span class="p">,</span>
                                               <span class="n">delta_time</span><span class="o">=</span><span class="n">time_delta</span><span class="p">,</span> <span class="n">frequency_offset</span><span class="o">=</span><span class="n">fq_offset</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">,</span>
                                               <span class="n">band</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">determine_band</span><span class="p">(</span><span class="n">frequency</span><span class="p">),</span> <span class="n">message</span><span class="o">=</span><span class="n">decoded_msg</span><span class="p">,</span> <span class="n">time_captured</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">packet_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">parsed_packet</span><span class="p">)</span>
                    <span class="k">except</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="ne">UnicodeDecodeError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to parse message packet: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">return</span>
                <span class="k">case</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Status packets</span>
                    <span class="k">pass</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error parsing packet: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="WsjtxParser.start_grabbing">
<a class="viewcode-back" href="../../index.html#ft8decoder.parser.WsjtxParser.start_grabbing">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">start_grabbing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">processor</span><span class="p">:</span> <span class="n">MessageProcessor</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">               Background thread to transfer packets from queue to processor.</span>

<span class="sd">               Continuously monitors the packet queue and transfers parsed packets</span>
<span class="sd">               to the MessageProcessor&#39;s data store. Runs in an infinite loop with</span>
<span class="sd">               a 1-second timeout to prevent blocking.</span>

<span class="sd">               Args:</span>
<span class="sd">                   processor (MessageProcessor): Processor instance to receive packets.</span>

<span class="sd">               Note:</span>
<span class="sd">                   This method runs in a separate thread and handles queue.Empty</span>
<span class="sd">                   exceptions gracefully to avoid blocking when no packets are available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">packet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">packet_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Block for 1 second max</span>
                <span class="n">processor</span><span class="o">.</span><span class="n">data_motherload</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error packet grabbing: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span></div>
</div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">ft8decoder</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, Christopher Cottone.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.1.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>